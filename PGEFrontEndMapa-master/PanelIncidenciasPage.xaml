<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="IntegrarMapa.PanelIncidenciasPage"
             Title="Panel de Incidencias">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- ENCABEZADO -->
            <Grid ColumnDefinitions="*, Auto">
                <Label Grid.Column="0"
                       Text="Panel de Incidencias"
                       FontSize="28"
                       FontAttributes="Bold"
                       TextColor="#1a1a1a"
                       VerticalOptions="Center" />
                <Button Grid.Column="1"
                        Text="⟳"
                        FontSize="20"
                        BackgroundColor="#007bff"
                        TextColor="White"
                        CornerRadius="20"
                        WidthRequest="40"
                        HeightRequest="40"
                        Clicked="OnRefrescarClicked" />
            </Grid>

            <!-- SECCIÓN DE BÚSQUEDA MEJORADA -->
            <Frame BackgroundColor="White"
                   BorderColor="#e0e0e0"
                   CornerRadius="16"
                   HasShadow="True"
                   Padding="20">
                <VerticalStackLayout Spacing="20">
                    <Label Text="Buscar incidencias"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="#222" />

                    <!-- PRIMERA FILA DE FILTROS -->
                    <Grid ColumnDefinitions="*, *"
                          ColumnSpacing="15">

                        <!-- Filtro Categoría -->
                        <VerticalStackLayout Spacing="5" Grid.Column="0">
                            <Label Text="Por categoría:" FontAttributes="Bold" TextColor="#555" />
                            <Picker x:Name="FiltroCategoria"
                                    Title="Todas las categorías..."
                                    BackgroundColor="#f0f2f5"
                                    TextColor="#222"
                                    HeightRequest="70" />
                        </VerticalStackLayout>

                        <!-- Filtro Estado -->
                        <VerticalStackLayout Spacing="5" Grid.Column="1">
                            <Label Text="Por estado:" FontAttributes="Bold" TextColor="#555" />
                            <Picker x:Name="FiltroEstado"
                                    Title="Todos los estados..."
                                    BackgroundColor="#f0f2f5"
                                    TextColor="#222"
                                    HeightRequest="70" />
                        </VerticalStackLayout>
                    </Grid>

                    <!-- SEGUNDA FILA DE FILTROS -->
                    <Grid ColumnDefinitions="*, *"
                          ColumnSpacing="15">

                        <!-- Filtro Descripción -->
                        <VerticalStackLayout Spacing="5" Grid.Column="0">
                            <Label Text="Por descripción:" FontAttributes="Bold" TextColor="#555" />
                            <Entry x:Name="FiltroDescripcion"
                                   Placeholder="Buscar en descripción..."
                                   PlaceholderColor="#999"
                                   BackgroundColor="#f0f2f5"
                                   TextColor="#222"
                                   HeightRequest="45" />
                        </VerticalStackLayout>

                        <!-- Filtro Usuario -->
                        <VerticalStackLayout Spacing="5" Grid.Column="1">
                            <Label Text="Por usuario:" FontAttributes="Bold" TextColor="#555" />
                            <Entry x:Name="FiltroUsuario"
                                   Placeholder="Nombre de usuario..."
                                   PlaceholderColor="#999"
                                   BackgroundColor="#f0f2f5"
                                   TextColor="#222"
                                   HeightRequest="45" />
                        </VerticalStackLayout>
                    </Grid>

                    <!-- TERCERA FILA DE FILTROS - FECHAS -->
                    <Grid ColumnDefinitions="*, *"
                          ColumnSpacing="15">

                        <!-- Filtro Fecha Desde -->
                        <VerticalStackLayout Spacing="5" Grid.Column="0">
                            <Label Text="Fecha desde:" FontAttributes="Bold" TextColor="#555" />
                            <DatePicker x:Name="FiltroFechaDesde"
                                        BackgroundColor="#f0f2f5"
                                        TextColor="#222"
                                        HeightRequest="45" />
                        </VerticalStackLayout>

                        <!-- Filtro Fecha Hasta -->
                        <VerticalStackLayout Spacing="5" Grid.Column="1">
                            <Label Text="Fecha hasta:" FontAttributes="Bold" TextColor="#555" />
                            <DatePicker x:Name="FiltroFechaHasta"
                                        BackgroundColor="#f0f2f5"
                                        TextColor="#222"
                                        HeightRequest="45" />
                        </VerticalStackLayout>
                    </Grid>

                    <!-- BOTONES -->
                    <Grid ColumnDefinitions="*, *" ColumnSpacing="15">
                        <Button Grid.Column="0"
                                Text="Buscar"
                                BackgroundColor="#007bff"
                                TextColor="White"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                HeightRequest="45"
                                Clicked="OnBuscarClicked" />

                        <Button Grid.Column="1"
                                Text="Limpiar"
                                BackgroundColor="#adb5bd"
                                TextColor="White"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                HeightRequest="45"
                                Clicked="OnLimpiarFiltrosClicked" />
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- RESULTADOS DE BÚSQUEDA -->
            <Frame x:Name="ResultadosView"
                   IsVisible="False"
                   BackgroundColor="White"
                   BorderColor="#e0e0e0"
                   CornerRadius="16"
                   HasShadow="True"
                   Padding="20">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Resultados de la búsqueda:"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="#333" />
                    <CollectionView x:Name="ResultadosCollection">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame BackgroundColor="#f8f9fa"
                                       CornerRadius="12"
                                       Padding="15"
                                       Margin="0,5">
                                    <Grid ColumnDefinitions="*, Auto, Auto" ColumnSpacing="10">
                                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                                            <Label Text="{Binding CategoriaNombre}"
                                                   FontAttributes="Bold"
                                                   TextColor="#222"
                                                   FontSize="14" />
                                            <Label Text="{Binding Descripcion}"
                                                   FontSize="13"
                                                   TextColor="#555"
                                                   MaxLines="2" />
                                            <Grid ColumnDefinitions="*, *">
                                                <Label Grid.Column="0"
                                                       Text="{Binding Fecha, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                                       FontSize="11"
                                                       TextColor="#777" />
                                                <Label Grid.Column="1"
                                                       Text="{Binding UsuarioNombre}"
                                                       FontSize="11"
                                                       TextColor="#999"
                                                       HorizontalOptions="End" />
                                            </Grid>
                                        </VerticalStackLayout>

                                        <Label Grid.Column="1"
                                               Text="{Binding Estado}"
                                               Padding="12,6"
                                               FontSize="12"
                                               FontAttributes="Bold"
                                               TextColor="White"
                                               BackgroundColor="{Binding EstadoColor}"
                                               VerticalOptions="Center"
                                               HorizontalTextAlignment="Center" />

                                        <Button Grid.Column="2"
                                                Text="Editar"
                                                BackgroundColor="#17a2b8"
                                                TextColor="White"
                                                FontSize="12"
                                                FontAttributes="Bold"
                                                CornerRadius="8"
                                                Padding="15,8"
                                                Clicked="OnEditarClicked" />
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- TODAS LAS INCIDENCIAS -->
            <Frame BackgroundColor="White"
                   BorderColor="#e0e0e0"
                   CornerRadius="16"
                   HasShadow="True"
                   Padding="20">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Todas las Incidencias"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="#222" />

                    <!-- INFORMACIÓN DE PAGINACIÓN -->
                    <Label x:Name="LblPaginacion"
                           FontSize="14"
                           TextColor="#666"
                           HorizontalOptions="Center"
                           IsVisible="False" />

                    <Label x:Name="LblResultado"
                           FontSize="14"
                           TextColor="#666"
                           IsVisible="False" />

                    <CollectionView x:Name="TablaIncidencias">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame BackgroundColor="#f8f9fa"
                                       CornerRadius="12"
                                       Padding="15"
                                       Margin="0,5">
                                    <Grid ColumnDefinitions="*, Auto, Auto, Auto" ColumnSpacing="10">
                                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                                            <Label Text="{Binding CategoriaNombre}"
                                                   FontAttributes="Bold"
                                                   TextColor="#222"
                                                   FontSize="14" />
                                            <Label Text="{Binding Descripcion}"
                                                   FontSize="13"
                                                   TextColor="#555"
                                                   MaxLines="2" />
                                            <Grid ColumnDefinitions="*, *">
                                                <Label Grid.Column="0"
                                                       Text="{Binding Fecha, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                                       FontSize="11"
                                                       TextColor="#777" />
                                                <Label Grid.Column="1"
                                                       Text="{Binding Id, StringFormat='ID: #{0}'}"
                                                       FontSize="11"
                                                       TextColor="#999"
                                                       HorizontalOptions="End" />
                                            </Grid>
                                            <Label Text="{Binding UsuarioNombre}"
                                                   FontSize="11"
                                                   TextColor="#666"
                                                   FontAttributes="Italic" />
                                        </VerticalStackLayout>

                                        <Label Grid.Column="1"
                                               Text="{Binding Estado}"
                                               Padding="12,6"
                                               FontSize="12"
                                               FontAttributes="Bold"
                                               TextColor="White"
                                               BackgroundColor="{Binding EstadoColor}"
                                               VerticalOptions="Center"
                                               HorizontalTextAlignment="Center" />

                                        <Button Grid.Column="2"
                                                Text="Editar"
                                                BackgroundColor="#17a2b8"
                                                TextColor="White"
                                                FontSize="12"
                                                FontAttributes="Bold"
                                                CornerRadius="8"
                                                Padding="15,8"
                                                Clicked="OnEditarClicked" />

                                        <Button Grid.Column="3"
                                                Text="Eliminar"
                                                BackgroundColor="#dc3545"
                                                TextColor="White"
                                                FontSize="12"
                                                FontAttributes="Bold"
                                                CornerRadius="8"
                                                Padding="15,8"
                                                Clicked="OnEliminarClicked" />
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- BOTÓN DE CARGAR MÁS -->
                    <Button x:Name="BtnCargarMas"
                            Text="Cargar 10 incidencias más"
                            BackgroundColor="#28a745"
                            TextColor="White"
                            FontAttributes="Bold"
                            CornerRadius="10"
                            HeightRequest="45"
                            Clicked="OnCargarMasClicked"
                            IsVisible="False" />
                </VerticalStackLayout>
            </Frame>

            <!-- LOADING + VOLVER -->
            <ActivityIndicator x:Name="loadingIndicator"
                               IsVisible="False"
                               IsRunning="False"
                               Color="#007bff"
                               VerticalOptions="Center" />
            <Button Text="Volver"
                    Clicked="OnVolverClicked"
                    BackgroundColor="#6c757d"
                    TextColor="White"
                    CornerRadius="10"
                    HeightRequest="45"
                    FontAttributes="Bold" />
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>